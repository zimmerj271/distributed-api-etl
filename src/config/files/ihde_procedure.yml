# ============================================================
# PIPELINE CONFIGURATION
# ============================================================

# -------------------------
# Endpoint Configuration
# -------------------------
endpoint:
  name: procedure 
  base_url: "https://tkg.orionhealthcloud.com/fhir/4.0"
  url_path: "https://tkg.orionhealthcloud.com/fhir/4.0/Procedure"
  method: GET 
  vendor: IHDE 
  headers:
    Accept: "application/fhir+json"
    Content-Type: "application/fhir+json"

# -------------------------
# Transport Decoratos
# -------------------------
transport:
  base_timeout: 30
  warmup_timeout: 10
  tcp_connection:
    limit: 10

# -------------------------
# Authentication
# -------------------------
auth:
  type: oauth2_password
  token_url: "https://orionhealth-tkg-prod.apigee.net/oauth2/token"
  client_id: "{{secret.kv-healthpartners-secrets:ihde-client-id}}"
  client_secret: "{{secret.kv-healthpartners-secrets:ihde-client-secret}}"
  username: "{{secret.kv-healthpartners-secrets:ihde-username}}"
  password: "{{secret.kv-healthpartners-secrets:ihde-password}}"
  refresh_margin: 60


# -------------------------
# Middleware Pipeline
# -------------------------
middleware:
  - type: logging
  - type: timing
  - type: json_body
  - type: retry
    max_attempts: 5
    retry_status_codes: [429, 500, 502, 503]
    base_delay: 0.2
    max_delay: 2.0


# -------------------------
# ETL Tables
# -------------------------
tables:
  source:
    name: procedure_test_api_staging
    namespace: keystone_dev.test
    id_column: tracking_id

    required_columns:
      - tracking_id
      - tulip_id

    table_schema:
      columns:
        - name: tracking_id
          type: string

        - name: tulip_id
          type: string

  sink:
    name: procedure_test_api_response
    namespace: keystone_dev.test
    mode: append

  column_mappings:
    - source_column: tulip_id 
      endpoint_param: patient 
